---
title: "HW4 - La Quinta is Spanish for next to Dennyâ€™s"
author:
- Cecily Abraham
- Jonathan Bryan
- Ran Zhou
- Ting Dai
output: 
  html_document: 
    highlight: pygments
    theme: flatly
---

### Load the data

```{r setup, include=FALSE}
library(rvest)
library(maps)
library(ggplot2)
library(knitr)
load("data/dennys.Rdata")
load("data/lq.Rdata")
```


###Web scraping
The html was scraped from the the local copy of the La Quinta HQ website. The full html was read into a string and then the hotel listing information from the html was isolated and stored. 




###Get the distance
To measure for the distance between two points on a sphere we used the Haversine formula. We use the radius of the Earth, and the distance between the La Quinta and Denny's to calculate their distance. We take the longitude and latitude of each Denny's and calculate the distance between each Denny's and the La Quinta hotels in meters. We then sum how many La Quinta's are within 100 meters of the Denny's. We then produce a map of the continental US with Denny's having La Quinita's nearby (which we define as within 100 meters) as red and those without La Quinta's nearby as blue. From visual inspection we can see that more Denny's have La Quinta's nearby in the Southeastern and Southwestern US. 

```{r}
# Cited from distHaversine function in geosphere package
distHaversine = function (p1, p2, r = 6378137) 
{
    toRad <- pi/180
    p1 <- p1 * toRad
    p2 <- p2 * toRad
    p = cbind(p1[, 1], p1[, 2], p2[, 1], p2[, 2], as.vector(r))
    dLat <- p[, 4] - p[, 2]
    dLon <- p[, 3] - p[, 1]
    a <- sin(dLat/2) * sin(dLat/2) + cos(p[, 2]) * cos(p[, 4]) * 
        sin(dLon/2) * sin(dLon/2)
    dist <- 2 * atan2(sqrt(a), sqrt(1 - a)) * p[, 5]
    return(as.vector(dist))
}
# Calculate the distance to all the La Quintas for each Denny's and save it into dist list
# In dist list, each element is a vector containing the distance between current denny's and all the La Quintas
dist = list()
# Create a vector to store if there is La Quintas nearby for each Denny's and append it to the denny's data frame for ploting
near_lq = rep(0, nrow(dennys))
# Create a vector to store if there is Denny's nearby for each La Quintas and append it to the denny's data frame for ploting
near_dennys = rep(0, nrow(hotels))
L = hotels[,c("long","lat")]
for(i in 1:nrow(dennys)){
  df1 = matrix(rep(c(dennys[[i,"long"]], dennys[[i, "lat"]]), nrow(L)), ncol=2, byrow=T)
  df2 = as.matrix(L)
  dis = distHaversine(df1, df2)
  dist[[i]] = dis
  # Find the pair if the distance is less than 100 meters
  near_lq[i] = sum(dis<100)
  if(sum(dis<100)>0){
    i = which(dis<100)
    near_dennys[i] = near_dennys[i]+1
  }
}
dennys$near_lq = near_lq
hotels$near_dennys = near_dennys
#load us map data
all_states = map_data("state")
#plot all states with ggplot and plot the information of Denny's and La Quintas
pair = dennys[dennys$near_lq>0,]
ggplot() + 
  geom_polygon( data=all_states, aes(x=long, y=lat, group = group),colour="white", fill="khaki1" ) +
  geom_point(data = dennys, aes(x = long, y=lat, colour = "Denny's"), size = 0.2) +
  geom_point(data = hotels, aes(x = long, y = lat, colour = "La Quintas"), size = 0.2) +
  geom_point(data = pair, aes(x = long, y=lat, colour = "Pairs"),size = 0.8) +
  theme_bw() +
  scale_color_manual(name = 'Have\n La Quintas\n nearby',
                     labels = c("Denny's","La Quintas","Pairs"),
                     values = c("cadetblue","darksalmon","black")) +
  ggtitle("Map of Denny's, La Quintas and the pairs ") 

info_lq = hotels%>%
  group_by(state)%>%
  summarise(percentage_lq = round(sum(near_dennys)/n(), digits = 2)) %>%
  arrange(desc(percentage_lq))
info_denny = dennys%>%
  group_by(state)%>%
  summarise(percentage_dennys = round(sum(near_lq)/n(), digits = 2))%>%
  arrange(desc(percentage_dennys))
info = merge(info_lq, info_denny)%>%
  arrange(desc(percentage_dennys))
colnames(info) = c("State","Percentage of Denny's having La Quintas nearby","Percentage of La Quintas having Denny's nearby")
kable(info)
```

